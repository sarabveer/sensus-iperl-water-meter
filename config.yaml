# Water Meter SSOCR
shell_command:
  water_meter_snapshot_ocr: "/bin/bash /config/scripts/water_meter_snapshot_ocr.sh"

# Command Line Sensors
command_line:
  # Water Meter OCR
  - sensor:
      name: water_meter_usage
      unique_id: water_meter_usage
      state_class: total_increasing
      unit_of_measurement: ft続
      device_class: water
      icon: mdi:gauge
      command: "/bin/bash /config/scripts/ssocr.sh"
      availability: "{{ (value | string) | trim | regex_match('^\\d{9}$') }}"
      value_template: >
        {% set raw = (value | string) | trim %}
        {# Must be exactly 9 digits from ssocr #}
        {% if not raw | regex_match('^\\d{9}$') %}
          {{ none }}
        {% else %}
          {# Convert to ft続 (XXXYYYZZZ -> XXXYYY.ZZZ) #}
          {% set candidate = (raw | int) / 1000 %}
          {# Reject obviously too-small overall readings (< 990 CCF = 99,000 ft続) #}
          {% if candidate < 99000 %}
            {{ none }}
          {% else %}
            {% set prev_state = states('sensor.water_meter_usage') %}
            {% if is_number(prev_state) %}
              {% set prev = prev_state | float %}
              {# Max allowed jump in ft続 per reading to avoid crazy OCR spikes #}
              {% set max_jump = 10 %}  {# ~75 gallons; adjust if needed #}
              {% set delta = candidate - prev %}
              {# Enforce: no going backwards, no huge jumps #}
              {% if 0 <= delta <= max_jump %}
                {{ candidate }}
              {% else %}
                {{ none }}
              {% endif %}
            {% else %}
              {# First valid reading: accept after basic sanity checks #}
              {{ candidate }}
            {% endif %}
          {% endif %}
        {% endif %}
